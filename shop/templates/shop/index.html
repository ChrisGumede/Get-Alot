{% extends 'shop/base.html' %} {% block content %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Get-Alot! Store</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <!-- Search Section -->
      <div class="row mt-3">
        <div class="col-md-10 offset-md-1">
          <button
            class="btn btn-primary mb-3"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasScrolling"
            aria-controls="offcanvasScrolling"
          >
            Today's Deals
          </button>

          <!-- Offcanvas for deals -->
          <div
            class="offcanvas offcanvas-start"
            data-bs-scroll="true"
            data-bs-backdrop="false"
            tabindex="-1"
            id="offcanvasScrolling"
            aria-labelledby="offcanvasScrollingLabel"
          >
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasScrollingLabel">
                Get-Alot! Hot Deals
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"
                aria-label="Close"
              ></button>
            </div>
            <div class="offcanvas-body">
              <p>Check out our amazing deals today!</p>
            </div>
          </div>

          <!-- Search form -->
          <form class="row g-2 align-items-center">
            <div class="col">
              <input
                type="search"
                name="product_name"
                placeholder="Search for products"
                class="form-control"
              />
            </div>
            <div class="col-auto">
              <button class="btn btn-success" type="submit">Search</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Products Grid -->
      <div class="row mt-4">
        {% for product in product_objects %}
        <div class="col-md-2 mb-4">
          <div class="card h-100">
            <img
              class="card-img-top"
              src="{{ product.image }}"
              alt="{{ product.title }}"
            />
            <div class="card-body d-flex flex-column">
              <p id="nm{{ product.id }}" class="card-title">
                {{ product.title }}
              </p>
              <h4 class="card-text">R {{ product.price }}</h4>
              <div class="mt-auto">
                <a href="/{{ product.id }}" class="btn btn-warning w-100 mb-2"
                  >View</a
                >
                <button id="{{ product.id }}" class="btn btn-warning w-100 atc">
                  Add to Cart
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      <div class="row">
        <div class="col-md-6 offset-md-3">
          <nav aria-label="Product pagination">
            <ul class="pagination justify-content-center">
              {% if product_objects.has_previous %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?page={{ product_objects.previous_page_number }}"
                  >Previous</a
                >
              </li>
              {% endif %}

              <li class="page-item active">
                <a class="page-link" href="?page={{ product_objects.number }}"
                  >{{ product_objects.number }}</a
                >
              </li>

              {% if product_objects.has_next %}
              <li class="page-item">
                <a
                  class="page-link"
                  href="?page={{ product_objects.next_page_number }}"
                  >Next</a
                >
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <footer class="mt-5 py-3 bg-light">
      <div class="container text-center">
        <p class="mb-0">&copy; 2024 Get-Alot! All rights reserved.</p>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Cart functionality using in-memory storage -->
    <script>
      // Use in-memory cart object instead of localStorage
      let cart = {};

      // Add to cart functionality
      $(document).on("click", ".atc", function () {
        console.log("Add to cart button clicked");
        const itemId = this.id.toString();

        if (cart[itemId] !== undefined) {
          cart[itemId][0] += 1;
        } else {
          const name = document.getElementById("nm" + itemId).innerHTML;
          cart[itemId] = [1, name];
        }

        console.log("Cart updated:", cart);
        updateCartDisplay();
      });

      // Update cart display
      function updateCartDisplay() {
        const cartCount = Object.keys(cart).length;
        const cartElement = document.getElementById("cart");

        if (cartElement) {
          cartElement.innerHTML = `Cart(${cartCount})`;
          displayCart();
        }
      }

      // Display cart popover
      function displayCart() {
        let cartString = "<h6>This is your cart</h6>";
        let cartIndex = 1;

        for (let itemId in cart) {
          const itemName =
            document.getElementById("nm" + itemId)?.innerHTML || "Unknown";
          cartString += `${cartIndex}. ${itemName} - Qty: ${cart[itemId][0]}<br>`;
          cartIndex++;
        }

        cartString += `<a href='/checkout' class='btn btn-success btn-sm mt-2'>Checkout</a>`;

        const cartElement = document.getElementById("cart");
        if (cartElement) {
          cartElement.setAttribute("data-bs-content", cartString);
          const popover = new bootstrap.Popover(cartElement, {
            html: true,
            sanitize: false,
          });
        }
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        displayCart();
      });
    </script>
  </body>
</html>

{% endblock %}
