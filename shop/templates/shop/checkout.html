{% extends 'shop/base.html' %} {% block title %}Checkout - Get Alot!{% endblock
%} {% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-lg-8">
      <h2 class="mb-4">Checkout</h2>

      <!-- Checkout Form -->
      <form id="checkoutForm" method="POST" action="/process-order/">
        {% csrf_token %}

        <!-- Contact Information -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Contact Information</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="customerName" class="form-label">Full Name *</label>
                <input
                  type="text"
                  class="form-control"
                  id="customerName"
                  name="customer_name"
                  placeholder="Chris Smith"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="customerEmail" class="form-label">Email *</label>
                <input
                  type="email"
                  class="form-control"
                  id="customerEmail"
                  name="customer_email"
                  placeholder="chris@gmail.com"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="customerPhone" class="form-label"
                  >Phone Number *</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="customerPhone"
                  name="customer_phone"
                  placeholder="+27 XX XXX XXXX"
                  required
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Shipping Address</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <label for="streetAddress" class="form-label"
                  >Street Address *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="streetAddress"
                  name="street_address"
                  placeholder="123 Main Street"
                  required
                />
              </div>
              <div class="col-12">
                <label for="addressLine2" class="form-label"
                  >Apartment, Suite, etc. (Optional)</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="addressLine2"
                  name="address_line2"
                  placeholder="Apt 4B"
                />
              </div>
              <div class="col-md-6">
                <label for="city" class="form-label">City *</label>
                <input
                  type="text"
                  class="form-control"
                  id="city"
                  name="city"
                  placeholder="Johannesburg"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="province" class="form-label">Province *</label>
                <select
                  id="province"
                  class="form-select"
                  name="province"
                  required
                >
                  <option value="" selected>Choose...</option>
                  <option value="GP">Gauteng</option>
                  <option value="WC">Western Cape</option>
                  <option value="KZN">KwaZulu-Natal</option>
                  <option value="EC">Eastern Cape</option>
                  <option value="FS">Free State</option>
                  <option value="LP">Limpopo</option>
                  <option value="MP">Mpumalanga</option>
                  <option value="NC">Northern Cape</option>
                  <option value="NW">North West</option>
                </select>
              </div>
              <div class="col-md-2">
                <label for="postalCode" class="form-label">Postal Code *</label>
                <input
                  type="text"
                  class="form-control"
                  id="postalCode"
                  name="postal_code"
                  placeholder="2000"
                  required
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Payment Method</h5>
          </div>
          <div class="card-body">
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                name="payment_method"
                id="cardPayment"
                value="card"
                checked
              />
              <label class="form-check-label" for="cardPayment">
                Credit/Debit Card
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                name="payment_method"
                id="cashPayment"
                value="cash"
              />
              <label class="form-check-label" for="cashPayment">
                Cash on Delivery
              </label>
            </div>
            <div class="form-check mb-2">
              <input
                class="form-check-input"
                type="radio"
                name="payment_method"
                id="eftPayment"
                value="eft"
              />
              <label class="form-check-label" for="eftPayment">
                EFT/Bank Transfer
              </label>
            </div>
          </div>
        </div>

        <!-- Hidden input for cart data -->
        <input type="hidden" id="cartData" name="cart_data" />

        <button type="submit" class="btn btn-success btn-lg w-100 mb-4">
          <i class="bi bi-lock-fill"></i> Place Order
        </button>
      </form>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm sticky-top" style="top: 20px">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush mb-3" id="item_list">
            <!-- Cart items will be dynamically inserted here -->
          </ul>

          <div
            id="emptyCartMessage"
            class="text-center text-muted py-4"
            style="display: none"
          >
            <p class="mb-2">Your cart is empty</p>
            <a href="/" class="btn btn-primary btn-sm">Continue Shopping</a>
          </div>

          <div id="orderTotals" style="display: none">
            <hr />
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span id="subtotal">R 0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Shipping:</span>
              <span id="shipping">R 0.00</span>
            </div>
            <hr />
            <div class="d-flex justify-content-between fw-bold">
              <span>Total:</span>
              <span id="total">R 0.00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Load cart from window.cart (set in base template)
  const cart = window.cart || {};

  function displayCheckoutItems() {
    const itemList = $("#item_list");
    const emptyMessage = $("#emptyCartMessage");
    const orderTotals = $("#orderTotals");

    itemList.empty();

    if (Object.keys(cart).length === 0) {
      emptyMessage.show();
      orderTotals.hide();
      return;
    }

    emptyMessage.hide();
    orderTotals.show();

    let subtotal = 0;

    for (let itemId in cart) {
      const itemName = cart[itemId][1];
      const quantity = cart[itemId][0];
      const price = cart[itemId][2] || 0; // Assuming price is stored as third element
      const itemTotal = price * quantity;

      subtotal += itemTotal;

      const itemHtml = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${itemName}</div>
                        <small class="text-muted">Quantity: ${quantity}</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">R ${itemTotal.toFixed(2)}</span>
                </li>
            `;

      itemList.append(itemHtml);
    }

    // Calculate shipping (free for orders over R500)
    const shipping = subtotal > 500 ? 0 : 50;
    const total = subtotal + shipping;

    // Update totals
    $("#subtotal").text(`R ${subtotal.toFixed(2)}`);
    $("#shipping").text(shipping === 0 ? "FREE" : `R ${shipping.toFixed(2)}`);
    $("#total").text(`R ${total.toFixed(2)}`);
  }

  // Form submission handler
  $("#checkoutForm").on("submit", function (e) {
    e.preventDefault();

    if (Object.keys(cart).length === 0) {
      alert("Your cart is empty. Please add items before checking out.");
      return false;
    }

    // Add cart data to hidden input
    $("#cartData").val(JSON.stringify(cart));

    // Show confirmation
    if (confirm("Are you sure you want to place this order?")) {
      // Submit the form
      this.submit();
    }
  });

  // Initialize on page load
  $(document).ready(function () {
    displayCheckoutItems();
  });
</script>
{% endblock %}
